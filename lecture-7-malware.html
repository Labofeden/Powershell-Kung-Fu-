<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PowerShell Kung Fu - Lecture 7: Malware Analysis</title>
    <style>
        :root {
            --dark-bg: #0a192f;
            --accent-green: #64ffda;
            --accent-yellow: #ffd700;
            --accent-blue: #1e90ff;
            --text-light: #ccd6f6;
            --danger-red: #ff5555;
        }
        body {
            font-family: 'Arial', sans-serif;
            background: var(--dark-bg);
            color: var(--text-light);
            line-height: 1.6;
            margin: 0;
            padding: 20px;
        }
        h1 {
            color: var(--danger-red);
            border-bottom: 2px solid var(--accent-yellow);
        }
        .malware-card {
            background: rgba(255, 85, 85, 0.1);
            border-radius: 8px;
            padding: 20px;
            margin: 25px 0;
            border-left: 4px solid var(--danger-red);
        }
        .analogy {
            background: rgba(255, 215, 0, 0.1);
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            font-style: italic;
        }
        .code-block {
            position: relative;
            background: #1a1a1a;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
        }
        .copy-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: var(--accent-blue);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
        }
        .copy-btn:hover {
            background: var(--accent-green);
        }
        .nav-links {
            display: flex;
            justify-content: space-between;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid var(--accent-blue);
        }
        .warning-sign {
            color: var(--danger-red);
            font-weight: bold;
        }
        .safety-protocol {
            background: rgba(100, 255, 218, 0.1);
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>ü¶† Lecture 7: Malware Analysis with PowerShell</h1>
    <p>Learn how to safely examine malicious software like a cybersecurity professional.</p>

    <div class="safety-protocol">
        <strong>‚ò¢Ô∏è SAFETY FIRST:</strong> Always analyze malware in a virtual machine with no network access!
    </div>

    <!-- Technique 1: Static Analysis -->
    <div class="malware-card">
        <h2>1. Static Analysis - Examining Without Running</h2>
        <p><strong>Why it matters:</strong> Like reading a suspect's diary, static analysis reveals malware secrets without the danger of execution.</p>
        
        <div class="analogy">
            <strong>üî¨ Think of it like:</strong> A doctor analyzing a virus under a microscope instead of infecting a patient.
        </div>
        
        <div class="code-block">
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
            <pre><code># Get file metadata (Often reveals malware origins)
Get-Item "suspect.exe" | Select-Object * | Format-List

# Extract strings from binary (Find hidden URLs/commands)
strings.exe suspect.exe | Select-String -Pattern "http|https|ftp|\.exe|\.dll"

# Check digital signature (Malware often lacks valid signatures)
Get-AuthenticodeSignature "suspect.exe" | Format-List</code></pre>
        </div>
        <p class="warning-sign">üö© <strong>Red Flags:</strong> No publisher, recent compilation date, or suspicious strings like "http://malicious.site"</p>
    </div>

    <!-- Technique 2: Behavioral Analysis -->
    <div class="malware-card">
        <h2>2. Behavioral Analysis - Safe Execution Monitoring</h2>
        <p><strong>Why it matters:</strong> Watching malware in a controlled environment reveals its true purpose.</p>
        
        <div class="analogy">
            <strong>üêÄ Think of it like:</strong> Scientists observing lab rats to understand disease effects.
        </div>
        
        <div class="code-block">
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
            <pre><code># Monitor process creation during malware execution
Start-Process -FilePath "suspect.exe" -WindowStyle Hidden
Get-WmiEvent -Query "SELECT * FROM Win32_ProcessStartTrace" |
    Where-Object { $_.ProcessName -eq "suspect.exe" } |
    Select-Object ProcessName, ProcessId, CommandLine

# Check registry changes (Malware often modifies registry)
$before = Get-ItemProperty HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Run
# Run malware here...
$after = Get-ItemProperty HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Run
Compare-Object $before $after -Property Property, Value</code></pre>
        </div>
        <p class="warning-sign">üíÄ <strong>Danger Signs:</strong> Creating processes named "svchost.exe" in Temp folders or adding startup entries</p>
    </div>

    <!-- Technique 3: Network Analysis -->
    <div class="malware-card">
        <h2>3. Network Traffic Analysis</h2>
        <p><strong>Why it matters:</strong> Malware often "phones home" to attacker servers - catching this can reveal attack sources.</p>
        
        <div class="analogy">
            <strong>üì° Think of it like:</strong> Tapping a spy's radio transmissions to learn their plans.
        </div>
        
        <div class="code-block">
            <button class="copy-btn" onclick="copyCode(this)">Copy</button>
            <pre><code># Capture network traffic (Requires admin)
Start-Process -FilePath "powershell" -ArgumentList "Start-NetEventSession -Name MalwareCapture"

# Run malware here...

# Stop capture and analyze
Stop-NetEventSession -Name MalwareCapture
$connections = Get-NetTCPConnection -State Established |
    Where-Object { $_.OwningProcess -eq (Get-Process -Name "suspect").Id }

$connections | Select-Object LocalAddress, LocalPort, RemoteAddress, RemotePort</code></pre>
        </div>
        <p class="warning-sign">üåê <strong>Suspicious Patterns:</strong> Connections to unknown countries or common malware ports (4444, 8080)</p>
    </div>

    <h2>ü¶† Malware Analysis Lab: The Suspicious Document</h2>
    <p>You receive a file <code>invoice.docm</code> that employees report crashes Word. Investigate:</p>
    <ol>
        <li>Check for macros (common malware vector)</li>
        <li>Analyze metadata for anomalies</li>
        <li>Monitor what processes it starts</li>
    </ol>

    <div class="code-block">
        <button class="copy-btn" onclick="copyCode(this)">Copy</button>
        <pre><code># Start your investigation here:
function Analyze-MaliciousDoc {
    param([string]$filePath)
    
    # Step 1: Check for macros
    
    # Step 2: Extract metadata
    
    # Step 3: Monitor behavior
}</code></pre>
    </div>

    <button onclick="showSolution()">Show Analysis Technique</button>
    <div id="solution" style="display: none;" class="code-block">
        <button class="copy-btn" onclick="copyCode(this)">Copy</button>
        <pre><code># Complete solution:
function Analyze-MaliciousDoc {
    param([string]$filePath)

    # 1. Check for VBA macros
    $hasMacros = Select-String -Path $filePath -Pattern "Sub\s+\w+\s*\(|Function\s+\w+\s*\("
    if ($hasMacros) {
        Write-Host "‚ö†Ô∏è DANGER: Document contains macros!" -ForegroundColor Red
        $vbaCode = [System.IO.File]::ReadAllText($filePath) | 
            Select-String -Pattern "(?s)Sub .*?End Sub|Function .*?End Function"
        $vbaCode | Out-File "C:\Analysis\extracted_macros.txt"
    }

    # 2. Analyze metadata
    $metadata = Get-Item $filePath | Select-Object *
    $metadata | Export-Clixml "C:\Analysis\file_metadata.xml"
    Write-Host "Metadata saved. Check creation time: $($metadata.CreationTime)"

    # 3. Monitor behavior
    $procWatch = Register-WmiEvent -Query "SELECT * FROM Win32_ProcessStartTrace" -Action {
        $e = $EventArgs.NewEvent
        if ($e.ParentProcessID -eq (Get-Process -Name "WINWORD").Id) {
            "$(Get-Date) - Spawned process: $($e.ProcessName) (PID: $($e.ProcessId))" |
                Out-File "C:\Analysis\process_log.txt" -Append
        }
    }

    # Simulate opening (In real lab: use isolated VM)
    Start-Process "WINWORD.EXE" -ArgumentList $filePath

    # Cleanup
    Start-Sleep -Seconds 10
    $procWatch | Unregister-Event
}
</code></pre>
    </div>

    <div class="nav-links">
        <a href="lecture-6-forensics.html">‚Üê Previous: Forensics</a>
        <a href="lecture-8-redteam.html">Next: Red Team PowerShell ‚Üí</a>
    </div>

    <script>
        function copyCode(button) {
            const codeBlock = button.parentElement;
            const code = codeBlock.querySelector('pre').innerText;
            navigator.clipboard.writeText(code).then(() => {
                button.textContent = 'Copied!';
                setTimeout(() => {
                    button.textContent = 'Copy';
                }, 2000);
            });
        }

        function showSolution() {
            const solution = document.getElementById('solution');
            solution.style.display = 'block';
            solution.scrollIntoView({ behavior: 'smooth' });
        }

        // ASCII Biohazard
        console.log('%c   _   \n  /_\  \n /_ _\ \n  /_\  \n /   \ \nDANGER ZONE',
                    'font-family: monospace; font-size: 14px; color: #ff5555;');
    </script>
</body>
</html>